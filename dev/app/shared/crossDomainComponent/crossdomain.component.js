"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require('@angular/core');
var router_1 = require('@angular/router');
var index_1 = require('../services/index');
var env_config_1 = require('./../../config/env.config');
var CrossDomainComponent = (function () {
    function CrossDomainComponent(subDomainService, companyService, loggedInService, _cookieService) {
        this.subDomainService = subDomainService;
        this.companyService = companyService;
        this.loggedInService = loggedInService;
        this._cookieService = _cookieService;
        this.isLocalStorageSet = false;
        this.domainUrl = env_config_1.Config.APP_EXTENSION;
        this.subDomain = subDomainService.subDomain;
        if (this._cookieService.readCookie('storage'))
            this.isLocalStorageSet = true;
    }
    CrossDomainComponent.prototype.ngOnInit = function () {
        var self = this;
        document.domain = this.domainUrl;
        if (self.subDomain.is_sub_domain_url) {
            if (self.isLocalStorageSet) {
                var storage = JSON.parse(this._cookieService.readCookie('storage'));
                self.companyService.isCompanyMember(localStorage.getItem('company'), storage.user._id)
                    .subscribe(function (data) {
                }, function (response) {
                    localStorage.removeItem('storage');
                });
            }
            window.onmessage = function (e) {
                self.subDomainOperations(e);
            };
        }
        else {
            var parent_1 = window.parent;
            var data = {
                'firstTimeLoaded': true,
                'method': 'set'
            };
            parent_1.postMessage(JSON.stringify(data), '*');
            window.onmessage = function (e) {
                self.mainDomainOperations(e);
            };
        }
    };
    CrossDomainComponent.prototype.ngAfterViewInit = function () {
    };
    CrossDomainComponent.prototype.subDomainOperations = function (e) {
        var self = this;
        var win = document.getElementById('mainUrlIframe').contentWindow;
        var payload = JSON.parse(e.data);
        switch (payload.method) {
            case 'set':
                if (payload.firstTimeLoaded) {
                    win.postMessage(JSON.stringify({ key: 'storage', method: 'get' }), '*');
                }
                else {
                    if (payload.storage && this._cookieService.readCookie('storage') != null) {
                        localStorage.setItem('crossDomainStorage', payload.storage);
                        self.subDomainService.subDomainExists();
                    }
                }
                break;
            case 'remove':
                if (this._cookieService.readCookie('storage')) {
                    localStorage.removeItem('storage');
                    self.loggedInService.logout();
                    window.location.reload();
                }
                break;
        }
    };
    CrossDomainComponent.prototype.mainDomainOperations = function (e) {
        var parent = window.parent;
        var self = this;
        var payload = JSON.parse(e.data);
        switch (payload.method) {
            case 'set':
                localStorage.setItem(payload.key, payload.data);
                break;
            case 'get':
                var data = {
                    'firstTimeLoaded': false,
                    'storage': localStorage.getItem(payload.key),
                    'method': 'set'
                };
                parent.postMessage(JSON.stringify(data), '*');
                break;
            case 'remove':
                localStorage.removeItem('storage');
                localStorage.removeItem('temp_name');
                localStorage.removeItem('domain');
                self.concatIframes();
                self.loggedInService.logout();
                var removeData = {
                    'removed': true
                };
                break;
        }
    };
    CrossDomainComponent.prototype.removeStorageFromSubDomains = function (companies) {
        companies.forEach(function (element) {
            var win = document.getElementById(element.sub_domain + element._id).contentWindow;
            if (win.localStorage.getItem('storage'))
                win.localStorage.removeItem('storage');
        });
    };
    CrossDomainComponent.prototype.concatIframes = function () {
        var _this = this;
        var companies;
        this.companyService.getCompanies()
            .subscribe(function (data) {
            companies = data;
            companies.forEach(function (element) {
                jQuery('<[iframe />');
                jQuery('<iframe />', {
                    name: element.sub_domain,
                    id: element.sub_domain + element._id,
                    src: env_config_1.Config.PROTOCOL + element.sub_domain + '.' + env_config_1.Config.APP_EXTENSION + '/crossDomainComponent'
                }).appendTo('body');
            });
            setTimeout(function () {
                this.removeStorageFromSubDomains(companies);
            }.bind(_this), 20000);
        }, function (response) {
        });
    };
    CrossDomainComponent.prototype.ngOnDestroy = function () {
    };
    CrossDomainComponent = __decorate([
        core_1.Component({
            moduleId: module.id,
            selector: 'og-cross-domain',
            template: "\n    <h1>cross domain operations</h1>\n  ",
            directives: [router_1.ROUTER_DIRECTIVES],
            providers: [index_1.CompanyService],
        }), 
        __metadata('design:paramtypes', [index_1.SubDomainService, index_1.CompanyService, index_1.LoggedInService, index_1.CookieService])
    ], CrossDomainComponent);
    return CrossDomainComponent;
}());
exports.CrossDomainComponent = CrossDomainComponent;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9zaGFyZWQvY3Jvc3NEb21haW5Db21wb25lbnQvY3Jvc3Nkb21haW4uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSxxQkFBNEQsZUFBZSxDQUFDLENBQUE7QUFDNUUsdUJBQWtDLGlCQUFpQixDQUFDLENBQUE7QUFFcEQsc0JBQWlGLG1CQUFtQixDQUFDLENBQUE7QUFDckcsMkJBQXVCLDJCQUEyQixDQUFDLENBQUE7QUFvQm5EO0lBSUksOEJBQW9CLGdCQUFrQyxFQUMxQyxjQUE4QixFQUM5QixlQUFnQyxFQUNoQyxjQUE0QjtRQUhwQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQzFDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsbUJBQWMsR0FBZCxjQUFjLENBQWM7UUFMeEMsc0JBQWlCLEdBQVksS0FBSyxDQUFDO1FBQ25DLGNBQVMsR0FBVyxtQkFBTSxDQUFDLGFBQWEsQ0FBQztRQU1yQyxJQUFJLENBQUMsU0FBUyxHQUFHLGdCQUFnQixDQUFDLFNBQVMsQ0FBQztRQUU1QyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUMxQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO0lBQ3RDLENBQUM7SUFFRCx1Q0FBUSxHQUFSO1FBQ0ksSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLFFBQVEsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUdqQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztZQUNuQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO2dCQUN6QixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BFLElBQUksQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7cUJBQ2pGLFNBQVMsQ0FDVixVQUFDLElBQVM7Z0JBRVYsQ0FBQyxFQUNELFVBQUMsUUFBYTtvQkFFVixZQUFZLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN2QyxDQUFDLENBQ0EsQ0FBQztZQUNWLENBQUM7WUFFRCxNQUFNLENBQUMsU0FBUyxHQUFHLFVBQVUsQ0FBTTtnQkFFL0IsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2hDLENBQUMsQ0FBQztRQUNOLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUVKLElBQUksUUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDM0IsSUFBSSxJQUFJLEdBQUc7Z0JBQ1AsaUJBQWlCLEVBQUUsSUFBSTtnQkFDdkIsUUFBUSxFQUFFLEtBQUs7YUFDbEIsQ0FBQztZQUNGLFFBQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUM5QyxNQUFNLENBQUMsU0FBUyxHQUFHLFVBQVUsQ0FBTTtnQkFDL0IsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pDLENBQUMsQ0FBQztRQUNOLENBQUM7SUEyQkwsQ0FBQztJQUVELDhDQUFlLEdBQWY7SUFTQSxDQUFDO0lBRUQsa0RBQW1CLEdBQW5CLFVBQW9CLENBQU07UUFDdEIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLElBQUksR0FBRyxHQUF1QixRQUFRLENBQUMsY0FBYyxDQUFDLGVBQWUsQ0FBRSxDQUFDLGFBQWEsQ0FBQztRQUN0RixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNyQixLQUFLLEtBQUs7Z0JBQ04sRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7b0JBQzFCLEdBQUcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBRTVFLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ0osRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO3dCQUN2RSxZQUFZLENBQUMsT0FBTyxDQUFDLG9CQUFvQixFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQzt3QkFFNUQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGVBQWUsRUFBRSxDQUFDO29CQUU1QyxDQUFDO2dCQUNMLENBQUM7Z0JBQ0QsS0FBSyxDQUFDO1lBQ1YsS0FBSyxRQUFRO2dCQUNULEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDNUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFDbkMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztvQkFDOUIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDN0IsQ0FBQztnQkFDRCxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0wsQ0FBQztJQUVELG1EQUFvQixHQUFwQixVQUFxQixDQUFNO1FBQ3ZCLElBQUksTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDM0IsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLEtBQUssS0FBSztnQkFDTixZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNoRCxLQUFLLENBQUM7WUFDVixLQUFLLEtBQUs7Z0JBQ04sSUFBSSxJQUFJLEdBQUc7b0JBQ1AsaUJBQWlCLEVBQUUsS0FBSztvQkFDeEIsU0FBUyxFQUFFLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQztvQkFDNUMsUUFBUSxFQUFFLEtBQUs7aUJBQ2xCLENBQUM7Z0JBQ0YsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUM5QyxLQUFLLENBQUM7WUFDVixLQUFLLFFBQVE7Z0JBQ1QsWUFBWSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDbkMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDckMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDbEMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO2dCQUNyQixJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUM5QixJQUFJLFVBQVUsR0FBRztvQkFDYixTQUFTLEVBQUUsSUFBSTtpQkFDbEIsQ0FBQztnQkFFRixLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0wsQ0FBQztJQUVELDBEQUEyQixHQUEzQixVQUE0QixTQUFnQjtRQUV4QyxTQUFTLENBQUMsT0FBTyxDQUFDLFVBQUEsT0FBTztZQUNyQixJQUFJLEdBQUcsR0FBdUIsUUFBUSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUUsQ0FBQyxhQUFhLENBQUM7WUFHdkcsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ3BDLEdBQUcsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQy9DLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELDRDQUFhLEdBQWI7UUFBQSxpQkF5QkM7UUF4QkcsSUFBSSxTQUFnQixDQUFDO1FBQ3JCLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxFQUFFO2FBQzdCLFNBQVMsQ0FDVixVQUFDLElBQVM7WUFFTixTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQ2pCLFNBQVMsQ0FBQyxPQUFPLENBQUMsVUFBQSxPQUFPO2dCQUNyQixNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQ3RCLE1BQU0sQ0FBQyxZQUFZLEVBQUU7b0JBQ2pCLElBQUksRUFBRSxPQUFPLENBQUMsVUFBVTtvQkFDeEIsRUFBRSxFQUFFLE9BQU8sQ0FBQyxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUc7b0JBQ3BDLEdBQUcsRUFBRSxtQkFBTSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxHQUFHLEdBQUcsR0FBRyxtQkFBTSxDQUFDLGFBQWEsR0FBQyx1QkFBdUI7aUJBQ2pHLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEIsQ0FBQyxDQUFDLENBQUM7WUFDSCxVQUFVLENBQUM7Z0JBQ1AsSUFBSSxDQUFDLDJCQUEyQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2hELENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLEVBQ1IsS0FBSyxDQUNSLENBQUM7UUFDTixDQUFDLEVBQ0QsVUFBQyxRQUFhO1FBRWQsQ0FBQyxDQUNBLENBQUM7SUFDVixDQUFDO0lBRUQsMENBQVcsR0FBWDtJQUdBLENBQUM7SUF2TUw7UUFBQyxnQkFBUyxDQUFDO1lBQ1AsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1lBQ25CLFFBQVEsRUFBRSxpQkFBaUI7WUFDM0IsUUFBUSxFQUFFLDRDQUVYO1lBQ0MsVUFBVSxFQUFFLENBQUMsMEJBQWlCLENBQUM7WUFDL0IsU0FBUyxFQUFFLENBQUMsc0JBQWMsQ0FBQztTQUM5QixDQUFDOzs0QkFBQTtJQWdNRiwyQkFBQztBQUFELENBOUxBLEFBOExDLElBQUE7QUE5TFksNEJBQW9CLHVCQThMaEMsQ0FBQSIsImZpbGUiOiJhcHAvc2hhcmVkL2Nyb3NzRG9tYWluQ29tcG9uZW50L2Nyb3NzZG9tYWluLmNvbXBvbmVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUk9VVEVSX0RJUkVDVElWRVMgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xyXG5pbXBvcnQgeyBTdWJEb21haW4gfSBmcm9tICcuLy4uL2ludGVyZmFjZXMvc3ViZG9tYWluLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFN1YkRvbWFpblNlcnZpY2UsIENvbXBhbnlTZXJ2aWNlLCBMb2dnZWRJblNlcnZpY2UsIENvb2tpZVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9pbmRleCc7XHJcbmltcG9ydCB7IENvbmZpZyB9IGZyb20gJy4vLi4vLi4vY29uZmlnL2Vudi5jb25maWcnO1xyXG5cclxuZGVjbGFyZSB2YXIgalF1ZXJ5OiBhbnk7XHJcbmRlY2xhcmUgdmFyIHdpbmRvdzogYW55O1xyXG5cclxuLypcclxuPHNpdGUtbmF2YmFyICpuZ0lmPVwiIXN1YkRvbWFpbiB8fCAoIWlzU3ViRG9tYWluICYmIGlzU3ViRG9tYWluPT09dW5kZWZpbmVkKVwiPjwvc2l0ZS1uYXZiYXI+XHJcbiAgICA8Y29tcGFueS1uYXZiYXIgKm5nSWY9XCJzdWJEb21haW4gfHwgKGlzU3ViRG9tYWluICYmIGlzU3ViRG9tYWluPT09dW5kZWZpbmVkKVwiPjwvY29tcGFueS1uYXZiYXI+XHJcbiAqL1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBtb2R1bGVJZDogbW9kdWxlLmlkLFxyXG4gICAgc2VsZWN0b3I6ICdvZy1jcm9zcy1kb21haW4nLFxyXG4gICAgdGVtcGxhdGU6IGBcclxuICAgIDxoMT5jcm9zcyBkb21haW4gb3BlcmF0aW9uczwvaDE+XHJcbiAgYCxcclxuICAgIGRpcmVjdGl2ZXM6IFtST1VURVJfRElSRUNUSVZFU10sXHJcbiAgICBwcm92aWRlcnM6IFtDb21wYW55U2VydmljZV0sXHJcbn0pXHJcblxyXG5leHBvcnQgY2xhc3MgQ3Jvc3NEb21haW5Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XHJcbiAgICBzdWJEb21haW46IFN1YkRvbWFpbjtcclxuICAgIGlzTG9jYWxTdG9yYWdlU2V0OiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBkb21haW5Vcmw6IHN0cmluZyA9IENvbmZpZy5BUFBfRVhURU5TSU9OO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBzdWJEb21haW5TZXJ2aWNlOiBTdWJEb21haW5TZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgY29tcGFueVNlcnZpY2U6IENvbXBhbnlTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgbG9nZ2VkSW5TZXJ2aWNlOiBMb2dnZWRJblNlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSBfY29va2llU2VydmljZTpDb29raWVTZXJ2aWNlXHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLnN1YkRvbWFpbiA9IHN1YkRvbWFpblNlcnZpY2Uuc3ViRG9tYWluO1xyXG4gICAgICAgIC8vIGRvY3VtZW50LmRvbWFpbiA9IHRoaXMuZG9tYWluVXJsO1xyXG4gICAgICAgIGlmICh0aGlzLl9jb29raWVTZXJ2aWNlLnJlYWRDb29raWUoJ3N0b3JhZ2UnKSlcclxuICAgICAgICAgICAgdGhpcy5pc0xvY2FsU3RvcmFnZVNldCA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKSB7XHJcbiAgICAgICAgbGV0IHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIGRvY3VtZW50LmRvbWFpbiA9IHRoaXMuZG9tYWluVXJsO1xyXG4gICAgICAgLy8gY29uc29sZS5sb2coJ2lzTG9jYWxTdG9yYWdlU2V0Jywgc2VsZi5pc0xvY2FsU3RvcmFnZVNldCk7XHJcbiAgICAgICAvLyBjb25zb2xlLmxvZygnaXNfc3ViX2RvbWFpbl91cmwnLCBzZWxmLnN1YkRvbWFpbi5pc19zdWJfZG9tYWluX3VybCwgJ2NvbXBhbnlfaWQnLCBzZWxmLnN1YkRvbWFpbi5jb21wYW55X2lkKTtcclxuICAgICAgICBpZiAoc2VsZi5zdWJEb21haW4uaXNfc3ViX2RvbWFpbl91cmwpIHtcclxuICAgICAgICAgICAgaWYgKHNlbGYuaXNMb2NhbFN0b3JhZ2VTZXQpIHtcclxuICAgICAgICAgICAgICAgIGxldCBzdG9yYWdlID0gSlNPTi5wYXJzZSh0aGlzLl9jb29raWVTZXJ2aWNlLnJlYWRDb29raWUoJ3N0b3JhZ2UnKSk7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmNvbXBhbnlTZXJ2aWNlLmlzQ29tcGFueU1lbWJlcihsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY29tcGFueScpLCBzdG9yYWdlLnVzZXIuX2lkKVxyXG4gICAgICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICAgICAgKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCd1c2VyIGNvbXBhbmllcycsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgKHJlc3BvbnNlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnbm90IGEgbWVtYmVyJywgcmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgnc3RvcmFnZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ2NvbXBhbnlfaWQnLCBzZWxmLnN1YkRvbWFpbi5jb21wYW55X2lkLCAndXNlcl9pZCcsIHNlbGYuc3ViRG9tYWluLnVzZXJfaWQpO1xyXG4gICAgICAgICAgICB3aW5kb3cub25tZXNzYWdlID0gZnVuY3Rpb24gKGU6IGFueSkge1xyXG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnaW5zaWRlIHN1YmRvbWFpbicsIGUpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5zdWJEb21haW5PcGVyYXRpb25zKGUpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIGRvY3VtZW50LmRvbWFpbiA9IHNlbGYuZG9tYWluVXJsO1xyXG4gICAgICAgICAgICBsZXQgcGFyZW50ID0gd2luZG93LnBhcmVudDtcclxuICAgICAgICAgICAgbGV0IGRhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICAnZmlyc3RUaW1lTG9hZGVkJzogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICdtZXRob2QnOiAnc2V0J1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBwYXJlbnQucG9zdE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkoZGF0YSksICcqJyk7XHJcbiAgICAgICAgICAgIHdpbmRvdy5vbm1lc3NhZ2UgPSBmdW5jdGlvbiAoZTogYW55KSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLm1haW5Eb21haW5PcGVyYXRpb25zKGUpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICAvL0ludGVyY29tXHJcbiAgICAgICAgLy8gdmFyIGludGVyY29tX2lkOiBzdHJpbmc7XHJcbiAgICAgICAgLy8gaWYgKCc8JT0gRU5WICU+JyA9PT0gJ3Byb2QnKSB7XHJcbiAgICAgICAgLy8gICAgIGludGVyY29tX2lkID0gJ3I4NDFnbmFnJztcclxuICAgICAgICAvLyB9IGVsc2Uge1xyXG4gICAgICAgIC8vICAgICBpbnRlcmNvbV9pZCA9ICdvbTJnb2g1Zyc7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICAgIC8vIGlmIChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnc3RvcmFnZScpKSB7XHJcbiAgICAgICAgLy8gICAgIGxldCBzdG9yYWdlID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnc3RvcmFnZScpKTtcclxuICAgICAgICAvLyAgICAgd2luZG93LkludGVyY29tKCdib290Jywge1xyXG4gICAgICAgIC8vICAgICAgICAgYXBwX2lkOiBpbnRlcmNvbV9pZCxcclxuICAgICAgICAvLyAgICAgICAgIGVtYWlsOiBzdG9yYWdlLnVzZXIuZW1haWxzWzBdLmVtYWlsLFxyXG4gICAgICAgIC8vICAgICAgICAgbmFtZTogc3RvcmFnZS51c2VyLm5hbWUsXHJcbiAgICAgICAgLy8gICAgICAgICBjcmVhdGVkX2F0OiAoTWF0aC5yb3VuZChEYXRlLnBhcnNlKHN0b3JhZ2UudXNlci5jcmVhdGVkQXQpLzEwMDApKSxcclxuICAgICAgICAvLyAgICAgICAgIHdpZGdldDoge1xyXG4gICAgICAgIC8vICAgICAgICAgICAgIGFjdGl2YXRvcjogJyNJbnRlcmNvbURlZmF1bHRXaWRnZXQnXHJcbiAgICAgICAgLy8gICAgICAgICB9XHJcbiAgICAgICAgLy8gICAgIH0pO1xyXG4gICAgICAgIC8vIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gICAgIHdpbmRvdy5JbnRlcmNvbSgnYm9vdCcsIHtcclxuICAgICAgICAvLyAgICAgICAgIGFwcF9pZDogaW50ZXJjb21faWQsXHJcbiAgICAgICAgLy8gICAgICAgICB3aWRnZXQ6IHtcclxuICAgICAgICAvLyAgICAgICAgICAgICBhY3RpdmF0b3I6ICcjSW50ZXJjb21EZWZhdWx0V2lkZ2V0J1xyXG4gICAgICAgIC8vICAgICAgICAgfVxyXG4gICAgICAgIC8vICAgICB9KTtcclxuICAgICAgICAvLyB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xyXG4gICAgICAgIC8vIGxldCBzZWxmID0gdGhpcztcclxuICAgICAgICAvLyBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAvLyAgICAgaWYgKCFsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY3Jvc3NEb21haW5TdG9yYWdlJykgJiYgIWxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzdG9yYWdlJykpXHJcbiAgICAgICAgLy8gICAgICAgICBzZWxmLnNob3dMb2FkZXIgPSBmYWxzZTtcclxuICAgICAgICAvLyAgICAgalF1ZXJ5KCcucHJlbG9hZGVyJykua2V5ZG93bigpO1xyXG4gICAgICAgIC8vIH0sXHJcbiAgICAgICAgLy8gICAgIDEyMDAwXHJcbiAgICAgICAgLy8gKTtcclxuICAgIH1cclxuXHJcbiAgICBzdWJEb21haW5PcGVyYXRpb25zKGU6IGFueSkge1xyXG4gICAgICAgIGxldCBzZWxmID0gdGhpcztcclxuICAgICAgICBsZXQgd2luID0gKDxIVE1MSUZyYW1lRWxlbWVudD5kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpblVybElmcmFtZScpKS5jb250ZW50V2luZG93O1xyXG4gICAgICAgIGxldCBwYXlsb2FkID0gSlNPTi5wYXJzZShlLmRhdGEpO1xyXG4gICAgICAgIHN3aXRjaCAocGF5bG9hZC5tZXRob2QpIHtcclxuICAgICAgICAgICAgY2FzZSAnc2V0JzpcclxuICAgICAgICAgICAgICAgIGlmIChwYXlsb2FkLmZpcnN0VGltZUxvYWRlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHdpbi5wb3N0TWVzc2FnZShKU09OLnN0cmluZ2lmeSh7IGtleTogJ3N0b3JhZ2UnLCBtZXRob2Q6ICdnZXQnIH0pLCAnKicpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBheWxvYWQuc3RvcmFnZSAmJiB0aGlzLl9jb29raWVTZXJ2aWNlLnJlYWRDb29raWUoJ3N0b3JhZ2UnKSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdjcm9zc0RvbWFpblN0b3JhZ2UnLCBwYXlsb2FkLnN0b3JhZ2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdpbnNpZGUgYXBwIENvbXBvbmVudCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnN1YkRvbWFpblNlcnZpY2Uuc3ViRG9tYWluRXhpc3RzKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdyZW1vdmUnOlxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2Nvb2tpZVNlcnZpY2UucmVhZENvb2tpZSgnc3RvcmFnZScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oJ3N0b3JhZ2UnKTtcclxuICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlZEluU2VydmljZS5sb2dvdXQoKTtcclxuICAgICAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbWFpbkRvbWFpbk9wZXJhdGlvbnMoZTogYW55KSB7XHJcbiAgICAgICAgbGV0IHBhcmVudCA9IHdpbmRvdy5wYXJlbnQ7XHJcbiAgICAgICAgbGV0IHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIGxldCBwYXlsb2FkID0gSlNPTi5wYXJzZShlLmRhdGEpO1xyXG4gICAgICAgIHN3aXRjaCAocGF5bG9hZC5tZXRob2QpIHtcclxuICAgICAgICAgICAgY2FzZSAnc2V0JzpcclxuICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHBheWxvYWQua2V5LCBwYXlsb2FkLmRhdGEpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2dldCc6XHJcbiAgICAgICAgICAgICAgICBsZXQgZGF0YSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAnZmlyc3RUaW1lTG9hZGVkJzogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgJ3N0b3JhZ2UnOiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShwYXlsb2FkLmtleSksXHJcbiAgICAgICAgICAgICAgICAgICAgJ21ldGhvZCc6ICdzZXQnXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgcGFyZW50LnBvc3RNZXNzYWdlKEpTT04uc3RyaW5naWZ5KGRhdGEpLCAnKicpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ3JlbW92ZSc6XHJcbiAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgnc3RvcmFnZScpO1xyXG4gICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oJ3RlbXBfbmFtZScpO1xyXG4gICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oJ2RvbWFpbicpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5jb25jYXRJZnJhbWVzKCk7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlZEluU2VydmljZS5sb2dvdXQoKTtcclxuICAgICAgICAgICAgICAgIGxldCByZW1vdmVEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICdyZW1vdmVkJzogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIC8vIHBhcmVudC5wb3N0TWVzc2FnZShyZW1vdmVEYXRhLCAnKicpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZVN0b3JhZ2VGcm9tU3ViRG9tYWlucyhjb21wYW5pZXM6IGFueVtdKSB7XHJcbiAgICAgICAgLy9jb25zb2xlLmxvZygndXNlciBjb21wYW5pZXMgaGhoaGhoaGhoaGhoaGhoaGhra2tra2tra2tra2tra2tra2tra2snLCBjb21wYW5pZXMpO1xyXG4gICAgICAgIGNvbXBhbmllcy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xyXG4gICAgICAgICAgICBsZXQgd2luID0gKDxIVE1MSUZyYW1lRWxlbWVudD5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbGVtZW50LnN1Yl9kb21haW4gKyBlbGVtZW50Ll9pZCkpLmNvbnRlbnRXaW5kb3c7XHJcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ3N1YiBkb21haW4gbG9jYWwgc3RvcmFnZSBhZnRlciByZW1vdmUnLCB3aW4ubG9jYWxTdG9yYWdlLCAnY29tcGFueSBlbGVtZW50JywgZWxlbWVudC5zdWJfZG9tYWluLCB3aW4ubG9jYXRpb24pO1xyXG5cclxuICAgICAgICAgICAgaWYgKHdpbi5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnc3RvcmFnZScpKVxyXG4gICAgICAgICAgICAgICAgd2luLmxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCdzdG9yYWdlJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uY2F0SWZyYW1lcygpIHtcclxuICAgICAgICBsZXQgY29tcGFuaWVzOiBhbnlbXTtcclxuICAgICAgICB0aGlzLmNvbXBhbnlTZXJ2aWNlLmdldENvbXBhbmllcygpXHJcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgIChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ3VzZXIgY29tcGFuaWVzIGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoJywgZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBjb21wYW5pZXMgPSBkYXRhO1xyXG4gICAgICAgICAgICAgICAgY29tcGFuaWVzLmZvckVhY2goZWxlbWVudCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KCc8W2lmcmFtZSAvPicpOyAgLy8gQ3JlYXRlIGFuIGlmcmFtZSBlbGVtZW50XHJcbiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KCc8aWZyYW1lIC8+Jywge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBlbGVtZW50LnN1Yl9kb21haW4sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBlbGVtZW50LnN1Yl9kb21haW4gKyBlbGVtZW50Ll9pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3JjOiBDb25maWcuUFJPVE9DT0wgKyBlbGVtZW50LnN1Yl9kb21haW4gKyAnLicgKyBDb25maWcuQVBQX0VYVEVOU0lPTisnL2Nyb3NzRG9tYWluQ29tcG9uZW50J1xyXG4gICAgICAgICAgICAgICAgICAgIH0pLmFwcGVuZFRvKCdib2R5Jyk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlU3RvcmFnZUZyb21TdWJEb21haW5zKGNvbXBhbmllcyk7XHJcbiAgICAgICAgICAgICAgICB9LmJpbmQodGhpcyksXHJcbiAgICAgICAgICAgICAgICAgICAgMjAwMDBcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIChyZXNwb25zZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdub3QgYSBtZW1iZXInLCByZXNwb25zZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpIHtcclxuICAgICAgICAvLyB3aW5kb3cuSW50ZXJjb20oJ2hpZGUnKTtcclxuICAgICAgICAvLyB3aW5kb3cuSW50ZXJjb20oJ3NodXRkb3duJyk7XHJcbiAgICB9XHJcbn1cclxuIl19
